<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Claim a Gift!</title>
  <link href="https://fonts.googleapis.com/css2?family=Shrikhand&family=Nunito&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:'Nunito',sans-serif;background:#fdf4ea;color:#4a3b3b}
    header{display:flex;justify-content:space-between;align-items:center;padding:20px 40px;border-bottom:2px solid #d6b18a}
    .logo{font-family:'Shrikhand',cursive;font-size:1.8em;color:#613c2d}
    nav a{margin-left:20px;text-decoration:none;padding:8px 16px;border-radius:20px;background:#ffe38c;color:#4a3b3b;border:2px solid #cc9345;font-weight:bold;transition:all .2s ease-in-out}
    nav a:hover{background:#ffd65d}
    nav a[target="_blank"]::after{content:" \2197"}
    .container{padding:60px 40px;max-width:800px;margin:auto}
    h1{font-family:'Shrikhand',cursive;font-size:3em;text-align:center;color:#502a1f;text-shadow:2px 2px #ffbf69;margin-bottom:30px}
    .form-section{background:#fff7ee;padding:30px;border-radius:15px;box-shadow:0 0 10px rgba(0,0,0,.1);margin-bottom:40px}
    select,button{font-size:1em;padding:10px 15px;margin-right:10px;border:2px solid #cc9345;border-radius:10px}
    button{background:#ffe38c;color:#4a3b3b;font-weight:bold;cursor:pointer;transition:all .2s ease-in-out}
    button:hover{background:#ffd65d}
    table{width:fit-content;margin:auto;border-collapse:separate;border-spacing:0;border-radius:15px;overflow:hidden;margin-top:30px;box-shadow:0 0 10px rgba(0,0,0,.05);background:#fff7ee}
    th,td{padding:22px 30px;font-size:1.5em}
    th{background:#ffe38c;font-family:'Shrikhand',cursive;color:#4a3b3b;text-align:left;border-bottom:2px solid #d6b18a}
    td{border-bottom:1px solid #f0dfc2}
    td.claimed{color:#aaa;font-style:italic}
    #debug{white-space:pre-wrap;font-size:.9em;color:#7b4b00;margin-top:16px}
  </style>
</head>
<body>
  <header>
    <div class="logo">🌼 BIRTHDAY WISHLIST</div>
    <nav><a href="index.html" target="_blank">Back to Home</a></nav>
  </header>

  <div class="container">
    <h1>Claim a Gift!</h1>
    <div class="form-section">
      <label for="gift-select">Choose a gift to claim:</label>
      <select id="gift-select"><option value="">-- Select a gift --</option></select>
      <button onclick="submitGift()">Claim</button>
      <div id="status-message" style="margin-top:10px;font-weight:bold;"></div>
      <div id="debug"></div>
    </div>

    <table>
      <thead><tr><th>Gift</th><th>Status</th></tr></thead>
      <tbody id="gift-table-body"></tbody>
    </table>
  </div>

  <script>
  // 🔗 Replace with your deployed Web App URL
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWX1ATM4pU4wsZz1fiyVSO89dycW6nbI_QeAp5v2FEilOgepppYFQPZr_wj_Zi1ZxA/exec';

  const selectEl = () => document.getElementById('gift-select');
  const tableEl  = () => document.getElementById('gift-table-body');
  const statusEl = () => document.getElementById('status-message');
  const debugEl  = () => document.getElementById('debug');

  // ----- JSONP loader (avoids CORS entirely) -----
  function jsonp(url, params = {}) {
    return new Promise((resolve, reject) => {
      const cbName = 'cb_' + Math.random().toString(36).slice(2);
      params.callback = cbName;
      params._ = Date.now();
      const qs = Object.entries(params).map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
      const script = document.createElement('script');
      script.src = url + (url.includes('?') ? '&' : '?') + qs;
      script.onerror = () => {
        delete window[cbName];
        script.remove();
        reject(new Error('JSONP load error'));
      };
      window[cbName] = (payload) => {
        resolve(payload);
        delete window[cbName];
        script.remove();
      };
      document.body.appendChild(script);
    });
  }

  // ----- Read list via JSONP from Apps Script -----
  async function loadGifts() {
    resetUI();
    try {
      const resp = await jsonp(SCRIPT_URL, { action: 'list' });
      if (!resp || resp.status !== 'ok' || !Array.isArray(resp.data)) {
        throw new Error('Bad response: ' + JSON.stringify(resp));
      }
      renderRows(resp.data);
      debugEl().textContent = ''; // clear debug
    } catch (e) {
      console.error(e);
      statusEl().textContent = '⚠️ Could not load gifts.';
      debugEl().textContent = String(e && e.message || e);
    }
  }

  // ----- Claim via text/plain then reload -----
  async function submitGift() {
    const sel = selectEl();
    const gift = sel.value;
    if (!gift) { alert('Please choose a gift first.'); return; }
    statusEl().textContent = '⏳ Submitting...';

    fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ gift })
    }).catch(() => { /* ignore POST errors due to CORS */ });

    setTimeout(async () => {
      await loadGifts();
      const stillThere = [...document.querySelectorAll('#gift-select option')].some(o => o.value === gift);
      statusEl().textContent = stillThere ? '⚠️ Could not verify. Try again or refresh.' : '🎉 Claim successful!';
      sel.value = '';
    }, 600);
  }

  function renderRows(rows) {
    const sel = selectEl();
    const tbody = tableEl();

    rows.forEach(r => {
      const isClaimed = r.claimed === true || String(r.claimed).toLowerCase() === 'true';

      if (!isClaimed) {
        const opt = document.createElement('option');
        opt.value = r.gift;
        opt.textContent = r.gift;
        sel.appendChild(opt);
      }

      const tr = document.createElement('tr');
      const tdGift = document.createElement('td');
      const tdStat = document.createElement('td');
      tdGift.textContent = r.gift;
      tdStat.textContent = isClaimed ? 'Claimed' : 'Available';
      if (isClaimed) {
        tdStat.className = 'claimed';
        tdStat.style.color = '#b8860b';
        tdStat.style.fontWeight = 'bold';
      }
      tr.appendChild(tdGift);
      tr.appendChild(tdStat);
      tbody.appendChild(tr);
    });
  }

  function resetUI() {
    selectEl().innerHTML = '<option value="">-- Select a gift --</option>';
    tableEl().innerHTML = '';
    // keep status/debug as-is so the user can see errors if any
  }

  window.onload = loadGifts;
  </script>
</body>
</html>
